<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Budget Pal - Connect Your Bank</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; padding: 32px; }
      .container { max-width: 560px; margin: 0 auto; }
      button { padding: 12px 16px; font-size: 16px; }
      pre { background: #f5f5f5; padding: 12px; overflow-x: auto; }
    </style>
    <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>Budget Pal</h1>
      <p>Connect your US Bank account via Plaid.</p>
      <button id="linkButton">Connect US Bank</button>
      <p id="status"></p>
      <pre id="log"></pre>
    </div>

    <script>
      const log = (msg) => {
        const el = document.getElementById('log');
        el.textContent += (typeof msg === 'string' ? msg : JSON.stringify(msg, null, 2)) + '\n';
      };
      const status = (msg) => { document.getElementById('status').textContent = msg; };

      async function createLinkToken() {
        const res = await fetch('/api/create_link_token', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: 'demo-user' }) });
        if (!res.ok) throw new Error('Failed to create link token');
        const data = await res.json();
        return data.link_token;
      }

      async function init() {
        try {
          status('Creating link token...');
          const linkToken = await createLinkToken();
          status('Initializing Plaid Link...');

          const handler = Plaid.create({
            token: linkToken,
            onSuccess: async (public_token) => {
              status('Exchanging public token...');
              const res = await fetch('/api/exchange_public_token', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ public_token }) });
              if (!res.ok) {
                const err = await res.json().catch(() => ({}));
                log(err);
                status('Failed to exchange public token');
                return;
              }
              status('Success! Access token stored on server. Run: npm run test:account');
            },
            onLoad: () => { status('Plaid Link loaded.'); },
            onExit: (err, metadata) => { if (err) log(err); log(metadata); },
            receivedRedirectUri: window.location.href
          });

          document.getElementById('linkButton').addEventListener('click', () => handler.open());
        } catch (e) {
          console.error(e);
          status('Error initializing Plaid Link');
          log(e.message || e);
        }
      }
      init();
    </script>
  </body>
  </html>


